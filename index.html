<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PJM Real-Time Energy Dashboard (Responsive)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    :root{ --bg1:#1e3c72; --bg2:#2a5298; --glass:rgba(255,255,255,.1); --glass-strong:rgba(255,255,255,.2); --ink:#fff; --muted:#a0c4ff; --pos:#4ade80; --neg:#f87171; --neu:#fbbf24; --card-radius:16px; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Calibri,Arial,sans-serif; background:linear-gradient(135deg,var(--bg1),var(--bg2)); color:var(--ink); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; overflow-x:hidden; display:flex; flex-direction:column; }
    .header{ position:sticky; top:0; z-index:10; backdrop-filter:saturate(120%) blur(8px); background:rgba(0,0,0,.25); border-bottom:1px solid rgba(255,255,255,.12); padding:12px 20px; display:flex; flex-direction:column; gap:6px; }
    .header h1{margin:0; font-weight:600; font-size:clamp(18px,2.4vw,28px)}
    .last-update{color:var(--muted); font-size:.95rem; display:flex; align-items:center; gap:.5rem}
    .status-indicator{width:10px; height:10px; border-radius:999px; display:inline-block}
    .status-live{background:var(--pos)} .status-delayed{background:var(--neu)} .status-offline{background:var(--neg)}
    .container{ width:min(1200px, 100% - 24px); margin-inline:auto; padding:18px 0 32px; flex:1; }
    .controls{display:grid; grid-template-columns:repeat(12,1fr); gap:12px; margin-bottom:16px}
    .control-group{grid-column:span 4; display:flex; flex-direction:column; gap:6px}
    .control-group label{color:var(--muted); font-size:.9rem}
    select, button, input[type="text"]{ appearance:none; outline:none; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.22); background:var(--glass); color:var(--ink); cursor:pointer; transition:.2s ease; }
    input[type="text"]{cursor:text}
    select:hover, button:hover{background:var(--glass-strong); transform:translateY(-1px)}
    .refresh-btn{grid-column:span 12; justify-self:start; background:linear-gradient(45deg,var(--pos),#22c55e); font-weight:700}
    #compareBtn{font-weight:600}
    .grid{display:grid; gap:14px; align-items:stretch; grid-template-columns:repeat(12,1fr)}
    .card{ grid-column:span 12; background:var(--glass); border:1px solid rgba(255,255,255,.18); border-radius:var(--card-radius); padding:14px; backdrop-filter:blur(8px); transition:box-shadow .25s ease, transform .25s ease; min-width:0; }
    .card:hover{box-shadow:0 12px 28px rgba(0,0,0,.25); transform:translateY(-3px)}
    .card h3{margin:0 0 10px; font-size:1.05rem; color:var(--muted)}
    .card:nth-child(1){grid-column:span 12}
    .card:nth-child(2){grid-column:span 12}
    .card:nth-child(3){grid-column:span 12}
    @media (min-width:720px){ .card:nth-child(1){grid-column:span 6} .card:nth-child(2){grid-column:span 6} .card:nth-child(3){grid-column:span 12} }
    @media (min-width:1000px){ .card:nth-child(1){grid-column:span 5} .card:nth-child(2){grid-column:span 4} .card:nth-child(3){grid-column:span 3} }
    .price-display{font-size:clamp(24px,4.2vw,40px); font-weight:800; text-align:center}
    .price-change{text-align:center; font-size:.95rem; margin:.35rem 0 8px}
    .positive{color:var(--pos)} .negative{color:var(--neg)} .neutral{color:var(--neu)}
    .chart-container{position:relative; height:280px}
    .large-chart{height:380px}
    .zone-grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:10px}
    .zone-card{background:rgba(0,0,0,.22); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:12px; text-align:center; cursor:pointer; transition:.2s}
    .zone-card:hover{background:rgba(255,255,255,.12)}
    .zone-card.selected{outline:2px solid var(--pos); background:rgba(74,222,128,.16)}
    .zone-name{font-size:.9rem; color:var(--muted); margin-bottom:.25rem}
    .zone-price{font-size:1.35rem; font-weight:700}
    .historical-section,.forecast-section{background:rgba(0,0,0,.2); border:1px solid rgba(255,255,255,.15); border-radius:var(--card-radius); padding:14px; margin-top:16px}
    .stats-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:10px}
    .stat-item{background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px; text-align:center}
    .forecast-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:10px; margin-top:10px}
    .forecast-item{background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:10px; text-align:center}
    .alert{background:rgba(248,113,113,.16); border:1px solid var(--neg); border-radius:12px; padding:12px; margin:12px 0}
    .loading-overlay{position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; place-items:center; z-index:1000}
    .loading-content{background:rgba(255,255,255,.1); padding:22px; border-radius:16px; text-align:center; border:1px solid rgba(255,255,255,.2)}
    .loading{display:inline-block; width:20px; height:20px; border:3px solid rgba(255,255,255,.3); border-radius:50%; border-top-color:#fff; animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (max-width:719.98px){ .controls{grid-template-columns:1fr; gap:10px} .control-group{grid-column:1 / -1} .refresh-btn{justify-self:stretch} .chart-container{height:240px} }
    @media (prefers-reduced-motion:reduce){ *{transition:none !important; animation:none !important} }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="loading" style="width:40px;height:40px;margin-bottom:12px"></div>
      <div>Loading data‚Ä¶</div>
      <div style="font-size:.9rem;color:var(--muted);margin-top:.4rem">This may take a few moments</div>
    </div>
  </div>

  <header class="header" role="banner">
    <h1>PJM Real-Time Energy Market Dashboard</h1>
    <div class="last-update">
      <span class="status-indicator status-live" id="statusDot" aria-hidden="true"></span>
      <span>Last Updated:</span> <span id="lastUpdate">Loading‚Ä¶</span>
    </div>
  </header>

  <main class="container" role="main">
    <section class="controls" aria-label="Controls">
      <div class="control-group">
        <label for="timeRange">Time Range</label>
        <select id="timeRange" aria-label="Time Range">
          <option value="1h">Last Hour</option>
          <option value="6h">Last 6 Hours</option>
          <option value="24h" selected>Last 24 Hours</option>
          <option value="7d">Last 7 Days</option>
          <option value="30d">Last 30 Days</option>
          <option value="365d">Last 365 Days</option>
        </select>
      </div>
      <div class="control-group">
        <label for="primaryZone">Primary Zone</label>
        <select id="primaryZone" aria-label="Primary Zone"></select>
      </div>
      <div class="control-group">
        <label>Compare Zones</label>
        <button id="compareBtn" type="button">Enable Compare</button>
      </div>
      <div class="control-group" style="grid-column:span 6">
        <label for="eiaKey">EIA API Key</label>
        <input id="eiaKey" type="text" placeholder="Enter EIA API key"
               value="hK7JhW2OHorJigMg2nComEjejKa5KNWQeaeKeU1n" />
        <div style="display:flex; gap:8px; margin-top:6px">
          <button type="button" id="connectBtn">Connect & Load</button>
          <button type="button" class="refresh-btn" id="autoBtn" style="background:transparent;border-color:rgba(255,255,255,.3)">
            <span id="autoTick">‚è±Ô∏è</span> Auto Refresh
          </button>
        </div>
      </div>
      <button class="refresh-btn" type="button" id="refreshBtn">
        <span id="refreshIcon">üîÑ</span> Refresh Data
      </button>
    </section>

    <section class="grid" aria-label="Overview">
      <article class="card">
        <h3>Real-Time LMP ‚Äì <span id="selectedZoneName">RTO Average</span></h3>
        <div class="price-display" id="currentPrice">$‚Äî</div>
        <div class="price-change neutral" id="priceChange">Waiting for data‚Ä¶</div>
        <div class="chart-container" id="priceChartContainer">
          <canvas id="priceChart" aria-label="LMP chart"></canvas>
        </div>
      </article>

      <article class="card">
        <h3>System Load</h3>
        <div class="price-display" id="systemLoad">‚Äî MW</div>
        <div class="price-change neutral" id="loadChange">Waiting for data‚Ä¶</div>
        <div class="chart-container"><canvas id="loadChart" aria-label="Load chart"></canvas></div>
      </article>

      <article class="card">
        <h3>Market Statistics</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px">
          <div style="text-align:center"><div style="color:var(--muted);font-size:.9rem">Peak Price</div><div style="font-size:1.2rem;font-weight:700" id="peakPrice">‚Äî</div></div>
          <div style="text-align:center"><div style="color:var(--muted);font-size:.9rem">Off-Peak</div><div style="font-size:1.2rem;font-weight:700" id="offPeakPrice">‚Äî</div></div>
          <div style="text-align:center"><div style="color:var(--muted);font-size:.9rem">Average</div><div style="font-size:1.2rem;font-weight:700" id="avgPrice">‚Äî</div></div>
          <div style="text-align:center"><div style="color:var(--muted);font-size:.9rem">Volatility</div><div style="font-size:1.2rem;font-weight:700" id="volatility">‚Äî</div></div>
        </div>
      </article>
    </section>

    <article class="card">
      <h3>Zone Pricing Overview <span style="font-size:.9rem;color:var(--muted)">(Tap to select/compare)</span></h3>
      <div class="zone-grid" id="zoneGrid"></div>
    </article>

    <section class="historical-section" id="historicalSection" hidden>
      <h3 style="margin-bottom:.6rem;color:var(--muted)">365-Day Historical Analysis</h3>
      <div class="stats-grid">
        <div class="stat-item"><div style="color:var(--muted);font-size:.9rem">Yearly High</div><div style="font-size:1.3rem;font-weight:700" id="yearlyHigh">‚Äî</div><div style="font-size:.8rem;color:var(--neg)" id="yearlyHighDate">‚Äî</div></div>
        <div class="stat-item"><div style="color:var(--muted);font-size:.9rem">Yearly Low</div><div style="font-size:1.3rem;font-weight:700" id="yearlyLow">‚Äî</div><div style="font-size:.8rem;color:var(--pos)" id="yearlyLowDate">‚Äî</div></div>
        <div class="stat-item"><div style="color:var(--muted);font-size:.9rem">Average Price</div><div style="font-size:1.3rem;font-weight:700" id="yearlyAvg">‚Äî</div><div style="font-size:.8rem;color:var(--neu)" id="yearlyStd">¬±‚Äî StdDev</div></div>
        <div class="stat-item"><div style="color:var(--muted);font-size:.9rem">Days > $100</div><div style="font-size:1.3rem;font-weight:700" id="highPriceDays">‚Äî</div><div style="font-size:.8rem;color:var(--neg)">‚Äî</div></div>
        <div class="stat-item"><div style="color:var(--muted);font-size:.9rem">Peak Season Avg</div><div style="font-size:1.3rem;font-weight:700" id="peakSeasonAvg">‚Äî</div><div style="font-size:.8rem;color:var(--neu)">Jun‚ÄìAug</div></div>
        <div class="stat-item"><div style="color:var(--muted);font-size:.9rem">Off-Peak Season</div><div style="font-size:1.3rem;font-weight:700" id="offPeakSeasonAvg">‚Äî</div><div style="font-size:.8rem;color:var(--pos)">Dec‚ÄìFeb</div></div>
      </div>
    </section>

    <section class="forecast-section">
      <h3 style="margin-bottom:.6rem;color:var(--muted)">24-Hour Price Forecast</h3>
      <div class="chart-container"><canvas id="forecastChart" aria-label="Forecast chart"></canvas></div>
      <div class="forecast-grid">
        <div class="forecast-item"><div style="color:var(--muted);font-size:.9rem">Next Hour</div><div style="font-size:1.2rem;font-weight:700" id="fcNextHour">‚Äî</div><div style="font-size:.8rem;color:var(--pos)" id="fcNextPct">‚Äî</div></div>
        <div class="forecast-item"><div style="color:var(--muted);font-size:.9rem">Peak Today</div><div style="font-size:1.2rem;font-weight:700" id="fcPeakToday">‚Äî</div><div style="font-size:.8rem;color:var(--neg)">High Risk</div></div>
        <div class="forecast-item"><div style="color:var(--muted);font-size:.9rem">Tomorrow Avg</div><div style="font-size:1.2rem;font-weight:700" id="fcTomorrow">‚Äî</div><div style="font-size:.8rem;color:var(--pos)">Favorable</div></div>
        <div class="forecast-item"><div style="color:var(--muted);font-size:.9rem">Week Trend</div><div style="font-size:1.2rem;font-weight:700" id="fcWeek">‚Äî</div><div style="font-size:.8rem;color:var(--neu)">Monitor</div></div>
      </div>
    </section>

    <div id="alerts" aria-live="polite"></div>
  </main>

  <script>
    // ===== Config =====
    const DEFAULT_RESPONDENT = 'PJM'; // RTO code in EIA
    let EIA_KEY = '';
    let autoTimer = null;

    // ===== Data (zones remain simulated for comparison) =====
    const pjmZones = [
      { code: 'RTO', name: 'RTO Average', price: 45.67, selected: true },
      { code: 'AECO', name: 'Atlantic Electric', price: 47.23, selected: false },
      { code: 'AEP', name: 'American Electric Power', price: 43.89, selected: false },
      { code: 'BGE', name: 'Baltimore Gas & Electric', price: 46.78, selected: false },
      { code: 'COMED', name: 'Commonwealth Edison', price: 41.56, selected: false },
      { code: 'DAYTON', name: 'Dayton Power & Light', price: 44.12, selected: false },
      { code: 'DEOK', name: 'Duke Energy OH/KY', price: 42.67, selected: false },
      { code: 'DOM', name: 'Dominion Virginia', price: 48.91, selected: false },
      { code: 'DPL', name: 'Delmarva Power', price: 46.45, selected: false },
      { code: 'DUQ', name: 'Duquesne Light', price: 43.78, selected: false },
      { code: 'JCPL', name: 'Jersey Central', price: 49.23, selected: false },
      { code: 'METED', name: 'Metropolitan Edison', price: 45.34, selected: false },
      { code: 'PECO', name: 'PECO Energy', price: 47.89, selected: false },
      { code: 'PENELEC', name: 'Penn Electric', price: 44.67, selected: false },
      { code: 'PEPCO', name: 'Potomac Electric', price: 48.12, selected: false },
      { code: 'PPL', name: 'PPL Electric', price: 45.56, selected: false },
      { code: 'PSEG', name: 'PSE&G', price: 50.23, selected: false },
      { code: 'RECO', name: 'Rockland Electric', price: 51.45, selected: false }
    ];

    let priceChart, loadChart, forecastChart;
    let compareMode=false, selectedZones=['RTO'];
    let historicalData={};

    // ===== EIA Helpers (V2 API) =====
    function buildEiaUrl({type, respondent=DEFAULT_RESPONDENT, hours=24}){
      const now = new Date();
      const end = now.toISOString().slice(0,13); // YYYY-MM-DDTHH
      const startDate = new Date(now.getTime() - hours*60*60*1000).toISOString().slice(0,13);
      const params = new URLSearchParams({
        api_key: EIA_KEY,
        frequency: 'hourly',
        'data[0]': 'value',
        'facets[respondent][]': respondent,
        'facets[type][]': type, // LMP or D
        start: startDate,
        end: end,
        sort: '[{"column":"period","direction":"asc"}]',
        offset: '0',
        length: String(hours+2)
      });
      return `https://api.eia.gov/v2/electricity/rto/region-data/data/?${params.toString()}`;
    }

    async function fetchEiaSeries(type, hours=24){
      if(!EIA_KEY) throw new Error('Missing EIA API key');
      const url = buildEiaUrl({type, hours});
      const res = await fetch(url);
      if(!res.ok) throw new Error(\`EIA \${type} HTTP \${res.status}\`);
      const json = await res.json();
      if(!json || !json.response || !json.response.data) throw new Error(\`EIA \${type} malformed response\`);
      const rows = json.response.data
        .filter(r => r.value !== null && r.period) // robust
        .map(r=>({ period: r.period, value: Number(r.value) }));
      if(!rows.length) throw new Error('EIA returned empty series');
      return rows;
    }

    function seriesToLabels(series){
      return series.map(r=>{
        const d = new Date(r.period);
        return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      });
    }

    // ===== Forecast util (deterministic: smoothing + trend) =====
    function makeForecastFromSeries(values, steps=12){
      // Holt‚Äôs linear trend (very lightweight)
      const alpha=0.4, beta=0.2;
      let level=values[0], trend=values[1]-values[0];
      for(let t=1;t<values.length;t++){
        const lastLevel=level;
        level = alpha*values[t] + (1-alpha)*(level + trend);
        trend = beta*(level - lastLevel) + (1-beta)*trend;
      }
      const fc=[];
      for(let k=1;k<=steps;k++){ fc.push(Number((level + k*trend).toFixed(2))); }
      return fc;
    }

    function generateForecastLabels(){
      const labels=[]; const now=new Date();
      for(let i=12; i>=1; i--){ const t=new Date(now.getTime()-i*3600*1000); labels.push(t.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})); }
      for(let i=1; i<=12; i++){ const t=new Date(now.getTime()+i*3600*1000); labels.push(t.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})); }
      return labels; // 24 labels
    }

    // ===== Init =====
    document.addEventListener('DOMContentLoaded', () => {
      updateLastUpdateTime();
      populatePrimaryZoneSelect();
      populateZoneGrid();
      initializeCharts();

      document.getElementById('connectBtn').addEventListener('click', () => window.connectEIA());
      document.getElementById('autoBtn').addEventListener('click', toggleAutoRefresh);
      document.getElementById('refreshBtn').addEventListener('click', refreshData);
      document.getElementById('compareBtn').addEventListener('click', toggleCompareMode);
      document.getElementById('timeRange').addEventListener('change', onRangeChange);
      document.getElementById('primaryZone').addEventListener('change', (e)=>{ if(!compareMode){ selectZone(e.target.value) }});

      // default key from input
      EIA_KEY = document.getElementById('eiaKey').value.trim();

      // quick smoke tests
      console.groupCollapsed('%cDashboard tests','color:#4ade80');
      console.assert(buildEiaUrl({type:'LMP'}).includes('/v2/electricity/rto/region-data/data/'),'EIA URL path');
      console.assert(Array.isArray(makeForecastFromSeries([10,11,12],3)),'forecast exists');
      console.groupEnd();
    });

    // Expose connectEIA globally
    window.connectEIA = async function connectEIA(){
      EIA_KEY = document.getElementById('eiaKey').value.trim();
      if(!EIA_KEY){ alert('Please paste a valid EIA API key.'); return; }
      await refreshFromEIA();
    }

    function toggleAutoRefresh(){
      if(autoTimer){
        clearInterval(autoTimer); autoTimer=null; document.getElementById('autoTick').textContent='‚è±Ô∏è';
      } else {
        autoTimer = setInterval(refreshFromEIA, 60_000);
        document.getElementById('autoTick').textContent='‚úÖ';
      }
    }

    async function refreshFromEIA(){
      showLoadingOverlay();
      try{
        const hours = Math.min(getHoursFromRange(document.getElementById('timeRange').value), 24);
        const [lmp, demand] = await Promise.all([
          fetchEiaSeries('LMP', hours),
          fetchEiaSeries('D',   hours)
        ]);

        // status dot is live if last sample within past 2 hours
        const lastPeriod = new Date(lmp.at(-1).period);
        const ageH = (Date.now() - lastPeriod.getTime())/3600000;
        document.getElementById('statusDot').className =
          'status-indicator ' + (ageH<=2 ? 'status-live' : ageH<=6 ? 'status-delayed' : 'status-offline');

        // Price card
        const labels = seriesToLabels(lmp);
        const lmpValues = lmp.map(d=>d.value);
        const current = lmpValues.at(-1);
        const prev = lmpValues.at(-2) ?? current;
        document.getElementById('currentPrice').textContent = `$${current.toFixed(2)}`;
        const diff = current-prev; const pct = (diff/prev)*100;
        const chEl = document.getElementById('priceChange');
        chEl.className = `price-change ${diff>0?'positive':diff<0?'negative':'neutral'}`;
        chEl.textContent = `${diff>0?'+':''}${diff.toFixed(2)} (${isFinite(pct)?(diff>0?'+':'')+pct.toFixed(1)+'%':'0.0%'})`;

        priceChart.data.labels = labels;
        priceChart.data.datasets = [{
          label:'PJM LMP ($/MWh)', data: lmpValues,
          borderColor:'#4ade80', backgroundColor:'rgba(74,222,128,.12)',
          tension:.3, fill:true, pointRadius:2
        }];
        priceChart.update();

        // Load
        const loadVals = demand.map(d=>d.value);
        document.getElementById('systemLoad').textContent =
          `${Math.round(loadVals.at(-1) || 0).toLocaleString()} MW`;
        loadChart.data.labels = seriesToLabels(demand);
        loadChart.data.datasets[0].data = loadVals;
        loadChart.update();

        // Forecast: 12-hr ahead from last 12 observed points
        const histForFc = lmpValues.slice(-12);
        const fc = makeForecastFromSeries(histForFc, 12);
        const fcLabels = generateForecastLabels();
        forecastChart.data.labels = fcLabels;
        forecastChart.data.datasets = [
          { label:'Historical', data:[...lmpValues.slice(-12), ...Array(12).fill(null)],
            borderColor:'#4ade80', backgroundColor:'rgba(74,222,128,.12)', tension:.3, pointRadius:2, spanGaps:true },
          { label:'Forecast',   data:[...Array(12).fill(null), ...fc],
            borderColor:'#f87171', backgroundColor:'rgba(248,113,113,.12)', borderDash:[5,5], tension:.3, pointRadius:2, spanGaps:true }
        ];
        forecastChart.update();

        // Forecast tiles
        const nextHour = fc[0];
        const nextPct = ((nextHour - current)/current)*100;
        document.getElementById('fcNextHour').textContent = `$${nextHour.toFixed(2)}`;
        document.getElementById('fcNextPct').textContent = `${nextPct>=0?'+':''}${nextPct.toFixed(1)}%`;

        const todayPeak = Math.max(...[...lmpValues.slice(-12), ...fc]);
        document.getElementById('fcPeakToday').textContent = `$${todayPeak.toFixed(2)}`;

        const tomorrowAvg = fc.reduce((a,b)=>a+b,0)/fc.length;
        document.getElementById('fcTomorrow').textContent = `$${tomorrowAvg.toFixed(2)}`;

        const weekTrend = (fc.at(-1) - histForFc[0]);
        document.getElementById('fcWeek').textContent = weekTrend>=0 ? 'Upward' : 'Downward';

        // Stats
        const max = Math.max(...lmpValues); const min = Math.min(...lmpValues);
        const avg = lmpValues.reduce((a,b)=>a+b,0)/lmpValues.length;
        const std = Math.sqrt(lmpValues.reduce((a,v)=>a+(v-avg)**2,0)/lmpValues.length);
        document.getElementById('peakPrice').textContent = `$${max.toFixed(2)}`;
        document.getElementById('offPeakPrice').textContent = `$${min.toFixed(2)}`;
        document.getElementById('avgPrice').textContent = `$${avg.toFixed(2)}`;
        document.getElementById('volatility').textContent = std>30?'High': std>15?'Medium':'Low';

        checkPriceAlerts(current);
      } catch(err){
        console.error(err);
        alert('EIA fetch failed. Showing simulated data. Check console for details.');
        refreshData(); // fallback to simulation
      } finally {
        hideLoadingOverlay(); updateLastUpdateTime();
      }
    }

    // ===== Charts, simulation & helpers (non-EIA) =====
    function initializeCharts(){
      const common={ responsive:true, maintainAspectRatio:false, interaction:{intersect:false,mode:'index'},
        plugins:{ legend:{display:true,labels:{color:'var(--muted)'}},
          tooltip:{backgroundColor:'rgba(0,0,0,.8)',titleColor:'#fff',bodyColor:'#fff',borderColor:'var(--pos)',borderWidth:1}},
        scales:{y:{grid:{color:'rgba(255,255,255,.1)'},ticks:{color:'var(--muted)'}},
                x:{grid:{color:'rgba(255,255,255,.1)'},ticks:{color:'var(--muted)',maxTicksLimit:20}}}};
      priceChart = new Chart(document.getElementById('priceChart').getContext('2d'), {
        type:'line',
        data:{ labels:generateTimeLabels(24), datasets:[{ label:'RTO Average LMP ($/MWh)', data:generatePriceData(24,'RTO'), borderColor:'#4ade80', backgroundColor:'rgba(74,222,128,.12)', tension:.4, fill:true, pointRadius:2, pointHoverRadius:5 }] },
        options:common
      });
      loadChart = new Chart(document.getElementById('loadChart').getContext('2d'), {
        type:'line',
        data:{ labels:generateTimeLabels(24), datasets:[{ label:'System Load (MW)', data:generateLoadData(24), borderColor:'#fbbf24', backgroundColor:'rgba(251,191,36,.12)', tension:.4, fill:true, pointRadius:2, pointHoverRadius:5 }] },
        options:common
      });
      forecastChart = new Chart(document.getElementById('forecastChart').getContext('2d'), {
        type:'line',
        data:{ labels:generateForecastLabels(),
          datasets:[
            { label:'Historical', data:[...generatePriceData(12,'RTO'), ...Array(12).fill(null)], borderColor:'#4ade80', backgroundColor:'rgba(74,222,128,.12)', tension:.4, pointRadius:2, spanGaps:true },
            { label:'Forecast', data:[...Array(12).fill(null), ...makeForecastFromSeries(generatePriceData(12,'RTO'),12)], borderColor:'#f87171', backgroundColor:'rgba(248,113,113,.12)', borderDash:[5,5], tension:.4, pointRadius:2, spanGaps:true }
          ] },
        options:common
      });
    }

    function onRangeChange(e){
      const r=e.target.value;
      const box=document.getElementById('priceChartContainer');
      if(r==='365d'){ box.classList.add('large-chart') } else { box.classList.remove('large-chart') }
      updateChartsForSelectedZones();
    }
    function updateLastUpdateTime(){ document.getElementById('lastUpdate').textContent = new Date().toLocaleString(); }
    function populatePrimaryZoneSelect(){
      const sel = document.getElementById('primaryZone');
      sel.innerHTML = pjmZones.map(z=>`<option value="${z.code}">${z.name}</option>`).join('');
      sel.value='RTO';
    }
    function populateZoneGrid(){
      const zoneGrid=document.getElementById('zoneGrid'); zoneGrid.innerHTML='';
      pjmZones.forEach(zone=>{
        const card=document.createElement('div'); card.className=`zone-card ${zone.selected?'selected':''}`;
        card.role='button'; card.tabIndex=0;
        card.addEventListener('click',()=>selectZone(zone.code));
        card.addEventListener('keypress',e=>{ if(e.key==='Enter' || e.key===' '){ selectZone(zone.code); }});
        const changePercent=(Math.random()-0.5)*10; const cls=changePercent>0?'positive':changePercent<0?'negative':'neutral';
        card.innerHTML=`<div class="zone-name">${zone.name}</div>
                        <div class="zone-price ${cls}">$${zone.price.toFixed(2)}</div>
                        <div style="font-size:.8rem;margin-top:.3rem">${changePercent>0?'+':''}${changePercent.toFixed(1)}%</div>`;
        zoneGrid.appendChild(card);
      });
    }
    function selectZone(code){
      if(compareMode){
        const z=pjmZones.find(x=>x.code===code); z.selected=!z.selected;
        selectedZones=pjmZones.filter(x=>x.selected).map(x=>x.code);
        if(!selectedZones.length){ pjmZones[0].selected=true; selectedZones=['RTO']; }
      } else {
        pjmZones.forEach(x=>x.selected=false);
        const z=pjmZones.find(x=>x.code===code); z.selected=true;
        selectedZones=[code]; document.getElementById('selectedZoneName').textContent=z.name;
        document.getElementById('primaryZone').value=code;
      }
      populateZoneGrid(); updateChartsForSelectedZones();
    }
    function toggleCompareMode(){
      compareMode=!compareMode;
      const btn=document.getElementById('compareBtn');
      btn.textContent = compareMode ? 'Disable Compare' : 'Enable Compare';
      if(!compareMode){
        pjmZones.forEach(z=>z.selected=false); pjmZones[0].selected=true;
        selectedZones=['RTO']; document.getElementById('selectedZoneName').textContent='RTO Average';
      }
      populateZoneGrid(); updateChartsForSelectedZones();
    }

    function updateChartsForSelectedZones(){
      const r=document.getElementById('timeRange').value;
      (compareMode && selectedZones.length>1) ? updateChartsComparison(r) : updateSingleZoneCharts(r, selectedZones[0]||'RTO');
    }

    function updateSingleZoneCharts(range, code){
      const zone=pjmZones.find(z=>z.code===code), name=zone?zone.name:'RTO Average';
      const priceBox=document.getElementById('priceChartContainer');
      if(range==='365d'){
        showLoadingOverlay();
        setTimeout(()=>{
          const d=generateHistoricalData(365,code); historicalData[code]=d;
          priceChart.data.labels=d.map(x=>x.date.toLocaleDateString());
          priceChart.data.datasets=[{label:`${name} LMP ($/MWh)`, data:d.map(x=>x.price), borderColor:'#4ade80', backgroundColor:'rgba(74,222,128,.12)', tension:.12, fill:true, pointRadius:0, pointHoverRadius:3}];
          priceChart.update();
          document.getElementById('historicalSection').hidden=false; priceBox.classList.add('large-chart');
          update365DayStats(code); hideLoadingOverlay();
        },600);
      } else {
        document.getElementById('historicalSection').hidden=true; priceBox.classList.remove('large-chart');
        const hours=getHoursFromRange(range), labels=generateTimeLabels(hours);
        priceChart.data.labels=labels;
        priceChart.data.datasets=[{label:`${name} LMP ($/MWh)`, data:generatePriceData(hours,code), borderColor:'#4ade80', backgroundColor:'rgba(74,222,128,.12)', tension:.4, fill:true, pointRadius:hours>168?0:2, pointHoverRadius:5}];
        priceChart.update();
        loadChart.data.labels=labels; loadChart.data.datasets[0].data=generateLoadData(hours); loadChart.update();
      }
    }

    function updateChartsComparison(range){
      const colors=['#4ade80','#f87171','#fbbf24','#8b5cf6','#06b6d4','#f97316','#ef4444','#10b981'];
      const priceBox=document.getElementById('priceChartContainer');
      if(range==='365d'){
        showLoadingOverlay(); setTimeout(()=>{
          const sets=selectedZones.map((code,i)=>{
            const z=pjmZones.find(x=>x.code===code);
            const d=generateHistoricalData(365,code); historicalData[code]=d;
            return {label:z.name, data:d.map(x=>x.price), borderColor:colors[i%colors.length], backgroundColor:colors[i%colors.length]+'20', tension:.12, fill:false, pointRadius:0, pointHoverRadius:3};
          });
          priceChart.data.labels=historicalData[selectedZones[0]].map(x=>x.date.toLocaleDateString());
          priceChart.data.datasets=sets; priceChart.update();
          document.getElementById('historicalSection').hidden=false; priceBox.classList.add('large-chart');
          update365DayStats(selectedZones[0]); hideLoadingOverlay();
        },800);
      } else {
        document.getElementById('historicalSection').hidden=true; priceBox.classList.remove('large-chart');
        const hours=getHoursFromRange(range), labels=generateTimeLabels(hours);
        priceChart.data.labels=labels;
        priceChart.data.datasets=selectedZones.map((code,i)=>{
          const z=pjmZones.find(x=>x.code===code);
          return {label:z.name, data:generatePriceData(hours,code), borderColor:colors[i%colors.length], backgroundColor:colors[i%colors.length]+'20', tension:.4, fill:false, pointRadius:hours>168?0:2, pointHoverRadius:5};
        });
        priceChart.update();
      }
    }

    function getHoursFromRange(r){ return r==='1h'?1: r==='6h'?6: r==='24h'?24: r==='7d'?168: r==='30d'?720: 24; }
    function showLoadingOverlay(){ document.getElementById('loadingOverlay').style.display='grid'; }
    function hideLoadingOverlay(){ document.getElementById('loadingOverlay').style.display='none'; }

    function generateTimeLabels(hours){
      const labels=[]; const now=new Date();
      if(hours>168){
        const days = Math.floor(hours/24);
        for(let i=days; i>0; i--){ const t=new Date(now.getTime()-i*24*60*60*1000); labels.push(t.toLocaleDateString()); }
      } else {
        for(let i=hours; i>0; i--){ const t=new Date(now.getTime()-i*60*60*1000); labels.push(t.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})); }
      }
      return labels;
    }

    // --- Sim generators (for non-live tiles & history/compare) ---
    function generatePriceData(points, code='RTO'){
      const z=pjmZones.find(v=>v.code===code); let base=z?z.price:45;
      const mult={ 'PSEG':1.1,'RECO':1.15,'JCPL':1.05,'DOM':1.02,'COMED':.95,'AEP':.97,'DEOK':.93,'DAYTON':.96}; base*=mult[code]||1;
      const out=[]; for(let i=0;i<points;i++){
        let p=base;
        if(points<=24){ const h=i%24; p*= (h>=7&&h<=9)||(h>=17&&h<=20)? 1.5+Math.random()*.5 : (h<=6? .6+Math.random()*.3 : .8+Math.random()*.4); }
        else if(points<=168){ const dow=Math.floor(i/24)%7, h=i%24; if(dow===0||dow===6) p*=.85; p*= (h>=7&&h<=20)? 1.2+Math.random()*.3 : .7+Math.random()*.2; }
        else { const seasonal=.8+Math.sin((i/points)*2*Math.PI)*.3; p*= seasonal + Math.random()*.4; }
        if(Math.random()<.02) p*=1.5+Math.random();
        out.push(Math.max(5, +p.toFixed(2)));
      }
      return out;
    }
    function generateLoadData(points){
      const out=[]; let base=85000;
      for(let i=0;i<points;i++){
        let l=base;
        if(points<=168){ const h=i%24, d=Math.floor(i/24)%7; if(d===0||d===6) l*=.9; l*= (h>=8&&h<=18)? 1.1+Math.random()*.1 : (h<=6? .8+Math.random()*.1 : .9+Math.random()*.1); }
        else { const seasonal=.9+Math.sin((i/points)*2*Math.PI)*.2; l*= seasonal + Math.random()*.1; }
        out.push(Math.round(l));
      }
      return out;
    }
    function generateHistoricalData(days, code){
      const out=[]; const now=new Date(); let base=pjmZones.find(z=>z.code===code)?.price||45;
      for(let i=days;i>0;i--){
        const d=new Date(now.getTime()-i*24*60*60*1000); const m=d.getMonth(); let price=base;
        if(m>=5&&m<=8){ price*=1.3+Math.random()*.4 } else if(m>=11||m<=1){ price*=1.1+Math.random()*.3 } else { price*=.8+Math.random()*.4 }
        if(Math.random()<.05){ price*=2+Math.random() }
        out.push({date:d, price:Math.max(5, price), zone:code});
      }
      return out;
    }
    function calculate365DayStats(data){
      const prices=data.map(d=>d.price);
      const avg=prices.reduce((a,b)=>a+b,0)/prices.length;
      const variance=prices.reduce((a,p)=>a+Math.pow(p-avg,2),0)/prices.length;
      const std=Math.sqrt(variance);
      const summer=data.filter(d=>{const m=d.date.getMonth(); return m>=5&&m<=7}).map(d=>d.price);
      const winter=data.filter(d=>{const m=d.date.getMonth(); return m>=11||m<=1}).map(d=>d.price);
      return {
        high:Math.max(...prices),
        low:Math.min(...prices),
        average:avg,
        stdDev:std,
        highPriceDays:prices.filter(p=>p>100).length,
        peakSeasonAvg: summer.length? summer.reduce((a,b)=>a+b,0)/summer.length:avg,
        offPeakSeasonAvg: winter.length? winter.reduce((a,b)=>a+b,0)/winter.length:avg
      }
    }
    function update365DayStats(code){
      const d=historicalData[code]; if(!d) return; const s=calculate365DayStats(d);
      document.getElementById('yearlyHigh').textContent=`$${s.high.toFixed(2)}`;
      document.getElementById('yearlyLow').textContent=`$${s.low.toFixed(2)}`;
      document.getElementById('yearlyAvg').textContent=`$${s.average.toFixed(2)}`;
      document.getElementById('yearlyStd').textContent=`¬±$${s.stdDev.toFixed(2)} StdDev`;
      document.getElementById('highPriceDays').textContent=s.highPriceDays;
      document.getElementById('peakSeasonAvg').textContent=`$${s.peakSeasonAvg.toFixed(2)}`;
      document.getElementById('offPeakSeasonAvg').textContent=`$${s.offPeakSeasonAvg.toFixed(2)}`;
      const v = s.stdDev>30? 'High' : s.stdDev>15? 'Medium' : 'Low';
      document.getElementById('volatility').textContent=v;
      document.getElementById('peakPrice').textContent=`$${s.high.toFixed(2)}`;
      document.getElementById('offPeakPrice').textContent=`$${s.low.toFixed(2)}`;
      document.getElementById('avgPrice').textContent=`$${s.average.toFixed(2)}`;
    }

    function checkPriceAlerts(price){
      const a=document.getElementById('alerts');
      if(price>80){
        a.innerHTML=`<div class="alert"><strong>‚ö†Ô∏è High Price:</strong> LMP > $80/MWh. Current: $${price.toFixed(2)}</div>`
      } else if(price<20){
        a.innerHTML=`<div class="alert" style="background:rgba(74,222,128,.16);border-color:var(--pos)"><strong>üìâ Low Price:</strong> LMP < $20/MWh. Current: $${price.toFixed(2)}</div>`
      } else { a.innerHTML='' }
    }

    function refreshData(){
      const icon=document.getElementById('refreshIcon');
      icon.innerHTML='<div class="loading"></div>';
      setTimeout(()=>{ updateLastUpdateTime(); updateChartsForSelectedZones(); populateZoneGrid(); icon.textContent='üîÑ'; }, 500);
    }
  </script>
</body>
</html>
